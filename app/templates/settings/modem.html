{% extends "base.html" %}
{% block title %}Настройка LTE модема{% endblock %}
{% block title_page %}Настройка подключения модема{% endblock %}
{% block content %}

<div class="row md-12 justify-content-center">
    <div class="col md-12">
        <div class="card">

            <div class="card-header">
                <div class="row d-flex">
                    <div class="col-6">
                    Быстрое подключение к интернету
                    </div>
                    <div class="col-6 d-flex justify-content-end align-items-center">
                        <span class="badge bg-info text-bg-dark modem_state">{{ form['modem_status'] | safe }}</span>
                    </div>
                </div>

            </div>

            <div class="card-body">
                <div class="form-check form-switch">
                    <form method="post" action="{{ url_for('settings.modem_settings') }}">
                        <input class="form-check-input" type="checkbox" role="switch"
                               name="connectionSwitch" id="connectionSwitch_1"
                               {% if form['modem_status'] == "CONNECTED" %} checked {% endif %}>
                        <label class="form-check-label" for="connectionSwitch_1">Connection off/on</label>
                    </form>

                </div>
            </div>

        </div>
    </div>
</div>


<div class="row md-6 d-flex justify-content-center">

    <div class="col md-6 mt-3">
        <div class="card">

            <div class="card-header">
                Настройка соединения LTE модема
            </div>

            <div class="card-body">

                <form class="form-horizontal">
                    <div class="form-group">
                        <label>APN</label>
                        <input placeholder="Введите APN" class="form-control" type="text" name="apn_input">
                    </div>

                    <div class="form-group mt-3">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="ipvX" value="4" id="flexRadio1" checked>
                            <label class="form-check-label" for="flexRadio1">
                                IPv4v6
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="ipvX" value="1" id="flexRadio2">
                            <label class="form-check-label" for="flexRadio2">
                                IPv4
                            </label>
                        </div>

                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="ipvX" value="2" id="flexRadio3">
                            <label class="form-check-label" for="flexRadio3">
                                IPv6
                            </label>
                        </div>
                    </div>

                    <div class="form-group mt-3">
                        <label>User</label>
                        <input placeholder="Оставьте поле пустым, если не знаете, что это"
                               class="form-control" name="user_input">
                    </div>

                    <div class="form-group mt-3">
                        <label>Password</label>
                        <input placeholder="Оставьте поле пустым, если не знаете, что это"
                               class="form-control" name="password_input">

                    </div>

                    <div class="form-group mt-3">
                        <button class="btn btn-primary init-connection-btn" type="button">Отправить</button>
                    </div>
                    <!--
                    <div class="form-group mt-3">
                    </div>
                    -->
                </form>

            </div>
        </div>
    </div>

    <div class="col md-6 mt-3">
        <div class="card">
            <form method="POST" action="{{ url_for('settings.modem_ussd_handler') }}">
            <div class="card-header">
                 USSD Запрос
            </div>
            <div class="card-body">
                <label>Введите запрос:</label>
                <div class="form-group mt-3">
                    <input class="form-control" type="text" id="input_value" name="input_form" required>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <button class="btn btn-primary" type="submit">Отправить</button>
                    </div>

                    <div id="ussd_request_hidden_button"
                         class= "col-md-6 {% if not (form['ussd_status'] == 'USER RESPONSE' or form['ussd_status'] == 'ACTIVE' ) %}
                         hidden {% endif %}">
                        <button id="cnl-btn" class="btn btn-secondary" type="submit">Завершить сессию</button>
                    </div>

                </div>
            </div>
            </form>
            <div class="card-body copy-container">

                <div class="d-flex mt-2">

                    <div class="col justify-content-start align-items-start">
                        <p>State: {{ form['ussd_status'] | safe }}</p>
                    </div>

                    <div class="col d-flex justify-content-md-end">
                        <button class="btn mt-0 me-0 copy-btn">
                            <svg class="bi opacity-75 theme-icon" aria-hidden="true">
                                <use class="copy_btn_svg" href="#clipboard"></use>
                            </svg>
                        </button>
                    </div>

                </div>

                <div class="row justify-content-center">
                    <pre type="text"  class="copy_text_field">
{% if form['response'] %}{{form['response'] | safe }} {% endif %}
                    </pre>
                </div>

            </div>
        </div>
    </div>

</div>


  <div class="container py-3">
    <p class="lead">
        Информация с модема
    </p>
    <hr>
  </div>


<div class="row md-6 mt-3 d-flex justify-content-center">

    <div class="col md-6 mt-3">
        <div class="card">
            <div class="card-header">
                Текущая информация
            </div>
            {% if form['show_modem'] %}
            <table class="table table-striped table-borderless text-center" style="margin: auto;">

            {% for Key, Value in form['show_modem'].items() %}
                <tr>
                    <th scope = "row">{{ Key | safe }}: </th>
                    <td>{{ Value | safe }}</td>
                </tr>
            {% endfor %}

            </table>
            {% else %}
                <h1>Модем не найден!</h1>
            {% endif %}
        </div>
    </div>

    <div class="col md-6 mt-3">
        <div class="card">
            <div class="card-header">
                Текущий статус соединения
            </div>
            <div class="card-body copy-container">

                <div class="d-flex justify-content-md-end ">

                    <div class="row">
                        <button class="btn mt-0 me-0 copy-btn">
                            <svg class="bi opacity-75 theme-icon" aria-hidden="true">
                                <use class="copy_btn_svg" href="#clipboard"></use>
                            </svg>
                        </button>
                    </div>

                </div>

                <div class="container d-flex justify-content-start">
                    <pre class="copy_text_field">
<span class="modem_state">State: {{ form['modem_status'] | safe }} </span>
<span class="modem_name">Name: {{ form['name_status'] | safe }} </span>
<span class="modem_apn">APN: {{ form['modem_current_apn'] | safe }} </span>
<span class="modem_ip">IPv code: {{ form['modem_current_ipv'] | safe }} </span>
<span>User: {{ form['modem_current_user'] | safe }} </span>
<span>Password: {{ form['modem_current_password'] | safe }} </span>
<span class="modem_address">Address: {{ form['address_status'] | safe }} </span>
<span class="modem_gateway">Gateway: {{ form['gateway_status'] | safe }} </span>
<span class="modem_dns">DNS: {{ form['dns_status'] | safe }} </span>
                    </pre>
                </div>

            </div>
        </div>
    </div>


</div>

{% endblock %}

{% block scripts %}

<script src="/static/js/select_options_button_handler.js"></script>
<script>

let secondary_button = document.getElementById("cnl-btn");
let input_value = document.getElementById("input_value");


if (secondary_button != null){
    secondary_button.addEventListener('click', () => {
    input_value.value = "ussd_cancel";
    // alert("USSD session canceled");
    });
}

let con_switch = document.getElementById('connectionSwitch_1');

con_switch.addEventListener('click', () => {
    let state = !con_switch.checked;
    let message = {status: state}
    // const data = {state: state};
    postJSON("/settings/switch", message);

});

let init_connection = document.querySelector('.init-connection-btn');

init_connection.addEventListener('click', () => {
    let apn = document.querySelector('[name="apn_input"]').value;
    let ip = document.querySelector('[name="ipvX"]').value;
    let user = document.querySelector('[name="user_input"]').value;
    let password = document.querySelector('[name="password_input"]').value;

    let message = {apn: apn, ip: ip, user: user, password: password};
    console.log(message)
    postJSON("/settings/init_connection_setup", message);
});

const eventSource = new EventSource('/settings/sse');

eventSource.onmessage = function(event) {
    function iter(name, array, dataArray, index) {
        array.forEach((point)=> {
        point.innerHTML = name + dataArray[index];
        });
    }
    // console.log(event.data)

    if (event.data !== '')
    {
        let modemConfig = JSON.parse(event.data)
        const modemState = document.querySelectorAll('.modem_state');
        iter("State: ", modemState, modemConfig, 0);

        const modemName = document.querySelectorAll('.modem_name');
        iter("Name: ", modemName, modemConfig, 1);

        const modemAddress = document.querySelectorAll('.modem_address');
        iter("Address: ", modemAddress, modemConfig, 2);

        const modemGateway = document.querySelectorAll('.modem_gateway');
        iter("Gateway: ", modemGateway, modemConfig, 3);

        const modemDNS = document.querySelectorAll('.modem_dns');
        iter("DNS: ", modemDNS, modemConfig, 4);
    }




};

</script>
{% endblock %}